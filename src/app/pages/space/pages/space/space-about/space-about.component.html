<ng-container *ngIf="deviceService.isMobile$ | async">
  <div class="flex items-center mt-5 ml-6">
    <nz-avatar [nzSrc]="avatarUrl" [nzSize]="40" class="border-2 bg-backgrounds-tertiary dark:bg-backgrounds-tertiary-dark border-tags-border dark:border-tags-border-dark min-w-10" nzShape="circle">
    </nz-avatar>
    <h1 class="w-2/3 mb-0 ml-4 text-2xl">{{ (data.space$ | async)?.name }}</h1>
  </div>

  <a nz-button class="flex items-center mt-5 mb-5 ml-6 wen-space-links" nzType="link" [routerLink]="['members']">
    <wen-icon-members class="text-foregrounds-secondary dark:text-foregrounds-secondary-dark"></wen-icon-members>
    <div class="ml-3">{{ (data.space$ | async)?.totalMembers }} <span i18n>members</span>
      <span *ngIf="(data.space$ | async)?.totalPendingMembers">
        {{'(' + (data.space$ | async)?.totalPendingMembers + ' pending)'}}
      </span>
    </div>
  </a>
</ng-container>

<wen-share
  class="block p-6 mb-4 lg:p-0"
  i18n-shareText
  shareText="Check out space"
  [shareUrl]="getShareUrl(data.space$ | async)">
</wen-share>

<nz-card nzTitle="About">
  <p nz-typography [innerHtml]="(data.space$ | async)?.about | markdown"
    class="text-base font-medium break-words whitespace-pre-line text-foregrounds-primary dark:text-foregrounds-primary-dark">
  </p>
</nz-card>

<nz-card i18n-nzTitle nzTitle="Token Info" class="lg:mt-4"
  *ngIf="(data.token$ | async) && ((data.isGuardianWithinSpace$ | async) || ((data.token$ | async)?.approved && (data.token$ | async)?.saleStartDate))">

  <div class="absolute top-6 right-6">
    <a nz-button nzType="default" [routerLink]="['/token', (data.token$ | async)?.uid, 'metrics']" nzSize="small">
      <div class="text-xs mr-0.5" i18n>Detail</div>
      <wen-icon-angle-right [size]="18"></wen-icon-angle-right>
    </a>
  </div>

  <wen-description [items]="[
    { title: tokenInfoLabels[0], valueTemplate: tokenAvatar },
    { title: tokenInfoLabels[1], value: (data.token$ | async)?.name },
    { title: tokenInfoLabels[2], value: (data.token$ | async)?.symbol },
    { title: tokenInfoLabels[3], value: '1 ' + (data.token$ | async)?.symbol + ' = ' + (data.token$ | async)?.pricePerToken + ' Mi' },
    { title: tokenInfoLabels[4], value: 'Shimmer comming', titleTemplate: networkTooltipIcon },
    { title: tokenInfoLabels[5], value:  (data.formatTokenBest((data.token$ | async)?.totalSupply) | number : '1.0-2') + ' ' + (data.token$ | async)?.symbol },
    { title: tokenInfoLabels[6], value: 'Fixed' }
  ]"></wen-description>
  <ng-template #tokenAvatar>
      <nz-avatar [nzSrc]="previewImageService.getAvatarSize((data.token$ | async)?.icon)"
          class="border-2 border-tags-border dark:border-tags-border-dark min-w-8"
          nzShape="circle"
          [nzSize]="32">
      </nz-avatar>
  </ng-template>
  <ng-template #networkTooltipIcon>
      <wen-icon-question-circle class="cursor-help" [size]="20"
          nz-tooltip i18n-nzTooltipTitle nzTooltipTitle="Guardian's of the space will be able to decide where this token will be minted."></wen-icon-question-circle>
  </ng-template>
</nz-card>

<nz-card *ngIf="deviceService.isDesktop$ | async" class="lg:mt-4">
  <div class="flex flex-col items-baseline space-y-3">
    <div class="flex items-center justify-between w-full">
      <a nz-button nzType="link" class="wen-space-links" style="border-radius: 0px" [routerLink]="['members']">
        <div>
          <div class="flex items-center">
            <wen-icon-members class="text-foregrounds-secondary dark:text-foregrounds-secondary-dark"></wen-icon-members>
            <div class="ml-2">{{ (data.space$ | async)?.totalMembers }}</div>
            <div class="ml-1" i18n>members</div>
          </div>
          <div *ngIf="(data.space$ | async)?.totalPendingMembers" class="flex items-center ml-6">
             <div>({{ (data.space$ | async)?.totalPendingMembers }}</div>
             <div class="ml-1" i18n>pending</div>)
          </div>
        </div>
      </a>

      <button nz-button nzType="default" nzSize="small" *ngIf="(data.isGuardianWithinSpace$ | async)" (click)="exportMembers()">
        <ng-container *ngIf="!exportingMembers">
          <wen-icon-file-export [size]="16"></wen-icon-file-export>
          <div class="ml-2" i18n>Export members</div>
        </ng-container>
        <ng-container *ngIf="exportingMembers">
          <wen-icon-refresh [size]="16" class="animate-spin" ></wen-icon-refresh>
          <div class="ml-2" i18n>Exporting members</div>
        </ng-container>

      </button>
    </div>
    <nz-tag class="px-2 py-1 text-xs border-none rounded-md bg-tags-commencing dark:bg-tags-commencing-dark border-tags-member dark:border-tags-member-dark text-foregrounds-primary dark:text-foregrounds-primary-dark">
      <ng-container *ngIf="(data.space$ | async)?.open; else requiresApprovalLabel" i18n>Open to join instantly</ng-container>
      <ng-template #requiresApprovalLabel i18n>Requires approval to join</ng-template>
    </nz-tag>
  </div>
</nz-card>

<nz-card class="relative lg:mt-4">
  <div class="flex items-center justify-between">
    <div class="flex items-center">
      <div class="text-lg font-bold" i18n>Connections</div>
      <div class="relative flex items-center justify-center ml-2">
        <wen-icon-question-circle class="cursor-help" nz-tooltip nzTooltipPlacement="right" i18n-nzTooltipTitle
          nzTooltipTitle="Connections between spaces enables members of one space to recognize members of another space's experience
        points. Established connection turns into alliances."></wen-icon-question-circle>
      </div>
    </div>
    <button nz-button nzType="link" nzSize="small" class="flex items-center"
      *ngIf="getSortedAlliances(data.space$ | async).length > 0" (click)="isAlliancesListOpen = true">
      <span i18n>Show All</span>
      <wen-icon-angle-right class="ml-2"></wen-icon-angle-right>
    </button>
  </div>

  <div class="w-5/6 mt-3 text-sm font-semibold text-foregrounds-secondary dark:text-foregrounds-secondary-dark" i18n>
    Connected spaces that you recognize
  </div>

  <div class="mt-6">
    <wen-space-alliances-table [isGuardian]="!!(data.isGuardianWithinSpace$ | async)"
      [alliances]="getSortedAlliances(data.space$ | async)" size="small" (wenOnAllianceEdit)="onAllianceEdit($event)">
    </wen-space-alliances-table>
  </div>

  <button *ngIf="(data.isGuardianWithinSpace$ | async)" nz-button nzType="primary" nzSize="small" i18n class="mt-8"
    (click)="openAlliance()">
    New connection
  </button>

  <nz-modal *ngIf="deviceService.isDesktop$ | async" [(nzVisible)]="isAlliancesListOpen" nzCentered [nzClosable]="false"
    [nzMaskClosable]="true" [nzMask]="true" (nzOnCancel)="isAlliancesListOpen = false"
    [nzContent]="alliancesListModalContent" [nzFooter]="null" [nzBodyStyle]="{ padding: '28px 24px 0px 24px' }"
    [nzWidth]="600">
    <ng-template #alliancesListModalContent>
      <div class="flex items-center justify-between">
        <div class="text-2xl font-bold">Space Connections</div>
        <button *ngIf="(data.isGuardianWithinSpace$ | async)" nz-button nzType="primary" nzSize="small" i18n
          (click)="openAlliance()">
          New connection
        </button>
      </div>

      <div class="overflow-y-auto h-96 mt-7">
        <wen-space-alliances-table [isGuardian]="!!(data.isGuardianWithinSpace$ | async)"
          [alliances]="getSortedAlliances(data.space$ | async)" size="large" (wenOnAllianceEdit)="onAllianceEdit($event)">
        </wen-space-alliances-table>
      </div>
    </ng-template>
  </nz-modal>

  <nz-drawer *ngIf="deviceService.isMobile$ | async" [nzBodyStyle]="{ overflow: 'auto', padding: '20px' }"
    [nzWidth]="'100vw'" [nzClosable]="false" [nzVisible]="isAlliancesListOpen">
    <div *nzDrawerContent class="relative h-full">
      <div class="w-screen px-4 pb-4 -ml-5 text-3xl font-bold shadow-header" #spaceAlliancesTitle>
        {{ (data.space$ | async)?.name }} <span i18n>connections</span></div>

      <wen-space-alliances-table [isGuardian]="!!(data.isGuardianWithinSpace$ | async)"
        class="block mt-2 overflow-y-auto" [ngStyle]="{
                    'max-height': 'calc(100% - ' +
                        ((spaceAlliancesTitle?.offsetHeight || 0) + (spaceAlliancesActions?.offsetHeight || 0) - 20) + 'px)'
                }" size="large" [alliances]="getSortedAlliances(data.space$ | async)"
        (wenOnAllianceEdit)="onAllianceEdit($event)">
      </wen-space-alliances-table>

      <div class="absolute bottom-0 z-10 flex items-center w-full bg-backgrounds-tertiary dark:bg-backgrounds-tertiary-dark" #spaceAlliancesActions>
        <button *ngIf="(data.isGuardianWithinSpace$ | async)" nz-button nzType="primary" nzSize="small" i18n
          (click)="openAlliance()">
          New connection
        </button>
        <button nz-button nzType="link" nzSize="small" class="ml-8" (click)="isAlliancesListOpen = false" i18n>
          Close
        </button>
      </div>
    </div>
  </nz-drawer>

  <nz-modal *ngIf="deviceService.isDesktop$ | async" [(nzVisible)]="isNewAllianceOpen" nzCentered [nzClosable]="false"
    [nzMaskClosable]="true" [nzMask]="true" (nzOnCancel)="closeNewAlliance()" [nzContent]="newAllianceModalContent"
    [nzFooter]="null" [nzBodyStyle]="{ padding: '28px 24px 24px 24px' }">
    <ng-template #newAllianceModalContent>
      <div class="flex items-start justify-between">
        <div class="text-2xl font-bold">
          <ng-container *ngIf="isNewAlliance; else notNewAlliance" i18n>New</ng-container>
          <ng-template #notNewAlliance i18n>Edit</ng-template>
          <span i18n> connection</span>
        </div>
        <wen-icon-close class="cursor-pointer" (click)="closeNewAlliance()"></wen-icon-close>
      </div>

      <div class="mt-7">
        <wen-space-new-alliance [spaces]="(cache.allSpaces$ | async) || []"
          [spaceAllianceControl]="spaceAllianceControl" [reputationWeightControl]="reputationWeightControl">
        </wen-space-new-alliance>
      </div>

      <div class="flex items-center justify-between mt-2">
        <div class="flex items-center">
          <button nz-button nzType="primary" nzSize="small" (click)="onAllianceSave()">
            <ng-container *ngIf="isNewAlliance; else desktopSaveAlliance" i18n>Form a connection</ng-container>
            <ng-template #desktopSaveAlliance i18n>Save</ng-template>
          </button>
          <button nz-button nzType="link" nzSize="small" class="ml-8" (click)="closeNewAlliance()" i18n>
            Cancel
          </button>
        </div>

        <div class="flex items-center text-sm font-semibold cursor-pointer text-accent-primary dark:text-accent-primary-darkest"
          (click)="onAllianceSave(false)" *ngIf="!isNewAlliance">
          <wen-icon-terminated class="mr-2"></wen-icon-terminated>
          <span i18n>Terminate alliance</span>
        </div>
      </div>
    </ng-template>
  </nz-modal>

  <nz-drawer *ngIf="deviceService.isMobile$ | async" [nzBodyStyle]="{ overflow: 'auto', padding: '20px' }"
    [nzWidth]="'100vw'" [nzClosable]="false" [nzVisible]="isNewAllianceOpen">
    <div *nzDrawerContent class="relative h-full">
      <div class="pb-4 text-3xl font-bold">
        <ng-container *ngIf="isNewAlliance; else mobileEditAlliance" i18n>New</ng-container>
        <ng-template #mobileEditAlliance i18n>Edit</ng-template>
        <span i18n> alliance</span>
      </div>

      <wen-space-new-alliance [spaces]="(cache.allSpaces$ | async) || []" [spaceAllianceControl]="spaceAllianceControl"
        [reputationWeightControl]="reputationWeightControl">
      </wen-space-new-alliance>

      <div class="z-10 flex items-center w-full bg-backgrounds-tertiary dark:bg-backgrounds-tertiary-dark">
        <button nz-button nzType="primary" nzSize="small" (click)="onAllianceSave()">
          <ng-container *ngIf="isNewAlliance; else mobileSaveAlliance" i18n>Form a connection</ng-container>
          <ng-template #mobileSaveAlliance i18n>Save</ng-template>
        </button>
        <button nz-button nzType="link" nzSize="small" class="ml-8" (click)="closeNewAlliance()" i18n>
          Cancel
        </button>
      </div>
      <div class="flex items-center mt-12 text-sm font-semibold cursor-pointer text-accent-primary dark:text-accent-primary-darkest"
        (click)="onAllianceSave(false)" *ngIf="!isNewAlliance">
        <wen-icon-terminated class="mr-2"></wen-icon-terminated>
        <span i18n>Terminate alliance</span>
      </div>
    </div>
  </nz-drawer>
</nz-card>

<nz-card [nzTitle]="titleTpl" class="lg:mt-4">
  <wen-wallet-address [entityType]="walletAddressEntities.SPACE" [entity]="(data.space$ | async)"
    [enableVerification]="!!(data.isGuardianWithinSpace$ | async)"></wen-wallet-address>

  <ng-template #titleTpl>
    <span i18n>Space's Wallet Address</span>
    <wen-icon-question-circle class="inline-block ml-2 cursor-help" nz-tooltip nzTooltipPlacement="right"
      i18n-nzTooltipTitle nzTooltipTitle="Wallet to hold funds for the Space.">
    </wen-icon-question-circle>
  </ng-template>
</nz-card>

<nz-card i18n-nzTitle nzTitle="Related Links" class="lg:mt-4"
  *ngIf="(data.space$ | async)?.github || (data.space$ | async)?.twitter || (data.space$ | async)?.discord">
  <div *ngIf="(data.space$ | async)?.github">
    <a nz-button class="wen-space-links" nzType="link" target="new" [href]="'https://github.com/' + (data.space$ | async)?.github">
      <wen-icon-github></wen-icon-github>
      <span>{{ (data.space$ | async)?.github }}</span>
    </a>
  </div>
  <div *ngIf="(data.space$ | async)?.twitter">
    <a nz-button class="wen-space-links" nzType="link" target="new" [href]="'https://twitter.com/' + (data.space$ | async)?.twitter">
      <wen-icon-twitter></wen-icon-twitter>
      <span>{{ (data.space$ | async)?.twitter }}</span>
    </a>
  </div>
  <div *ngIf="(data.space$ | async)?.discord">
    <a nz-button class="wen-space-links" nzType="link" target="new" [href]="'https://discord.gg/' + (data.space$ | async)?.discord">
      <wen-icon-discord></wen-icon-discord>
      <span>{{'discord.gg/' + (data.space$ | async)?.discord}}</span>
    </a>
  </div>
</nz-card>

<nz-card [nzTitle]="(data.space$ | async)?.totalGuardians + ' Guardians'" class="lg:mt-4">
  <div class="space-y-2" *ngIf="data.guardians$">
    <div *ngFor="let g of data.guardians$ | async; trackBy: trackByUid"
      class="text-base font-medium cursor-pointer text-foregrounds-primary dark:text-foregrounds-primary-dark" [routerLink]="['/', 'member', g.uid]">
      <nz-avatar nzIcon="user" [nzSrc]="g.currentProfileImage | ipfsAvatar:filesizes.small" class="mr-2"
        [nzSize]="(deviceService.isDesktop$ | async) ? 'default' : 32">
      </nz-avatar>
      <span [routerLink]="data.getMemberUrl ? data.getMemberUrl(g.uid) : ''">@ {{ (g.name || g.uid) | truncate:[16]}}</span>
    </div>
  </div>
</nz-card>

<div class="pt-6 lg:mt-4 lg:pt-0">
  <button class="flex justify-center" nz-button nzBlock nzDanger (click)="wenOnLeave.emit()"
    *ngIf="!!(data.isMemberWithinSpace$ | async)">
    <wen-icon-log-out class="mr-2 "></wen-icon-log-out>
    <span i18n>Leave Space</span>
  </button>
</div>
