<wen-content [showBackButton]="(deviceService.isDesktop$ | async) || false">
  <h1 class="mt-7" i18n>New Proposal</h1>

  <form nz-form nzLayout="vertical" [formGroup]="proposalForm">
    <div class="py-4" nz-row [nzGutter]="24">
      <div
        class="space-y-4"
        nz-col
        nzFlex="auto"
        [ngStyle]="{
          'max-width': (deviceService.isDesktop$ | async) ? 'calc(100% - 450px)' : '100%'
        }"
      >
        <nz-card [nzBordered]="false">
          <nz-card-meta
            i18n-nzTitle
            nzTitle="Proposal info"
            i18n-nzDescription
            nzDescription="Title and description will be included on the Proposal. Start and end dates determine the duration of the Proposal."
          >
          </nz-card-meta>
          <nz-form-item class="mt-4">
            <nz-form-control i18n-nzErrorTip nzErrorTip="Title is required.">
              <input
                nz-input
                i18n-placeholder
                placeholder="Title"
                nzSize="large"
                [formControl]="nameControl"
              />
            </nz-form-control>
          </nz-form-item>
          <div class="flex grow space-x-4" *ngIf="selectedGroupControl.value !== targetGroups.NATIVE">
            <nz-form-item class="w-full">
              <nz-form-control i18n-nzErrorTip nzErrorTip="Start Date is required.">
                <nz-date-picker
                  class="flex grow"
                  nzSize="large"
                  [nzDisabledDate]="disabledStartDate.bind(this)"
                  [nzShowTime]="{ nzFormat: 'HH:mm', nzMinuteStep: 5, nzHideDisabledOptions: true }"
                  nzFormat="yyyy-MM-dd HH:mm"
                  [formControl]="startControl"
                  i18n-nzPlaceHolder
                  nzPlaceHolder="Start"
                  (nzOnOpenChange)="handleStartOpenChange($event)"
                >
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item class="w-full">
              <nz-form-control i18n-nzErrorTip nzErrorTip="End Date is required.">
                <nz-date-picker
                  class="flex grow"
                  nzSize="large"
                  #endDatePicker
                  [nzDisabledDate]="disabledEndDate.bind(this)"
                  [nzShowTime]="{ nzFormat: 'HH:mm', nzMinuteStep: 5, nzHideDisabledOptions: true }"
                  nzFormat="yyyy-MM-dd HH:mm"
                  [formControl]="endControl"
                  i18n-nzPlaceHolder
                  nzPlaceHolder="End"
                ></nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div *ngIf="selectedGroupControl.value === targetGroups.NATIVE">
            <nz-form-item>
              <nz-form-control i18n-nzErrorTip nzErrorTip="Commencing milestone.">
                <nz-input-group nzCompact [nzAddOnAfter]="(getDateBasedOnMilestone(milestoneIndexCommenceControl.value) | date:'short') || undefined">
                  <nz-input-number class="w-full rounded-r-none"
                    nzSize="large"
                    [nzMin]="(lastMilestone$ | async)?.cmi || 0"
                    [formControl]="milestoneIndexCommenceControl"
                    i18n-nzPlaceHolder
                    nzPlaceHolder="Commencing milestone"
                  >
                  </nz-input-number>
                </nz-input-group>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-control i18n-nzErrorTip nzErrorTip="Start milestone.">
                <nz-input-group [nzAddOnAfter]="(getDateBasedOnMilestone(milestoneIndexStartControl.value) | date:'short') || undefined">
                  <nz-input-number class="w-full rounded-r-none"
                    nzSize="large"
                    [nzMin]="milestoneIndexCommenceControl.value"
                    [formControl]="milestoneIndexStartControl"
                    i18n-nzPlaceHolder
                    nzPlaceHolder="Start milestone"
                  >
                </nz-input-number>
                </nz-input-group>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-control i18n-nzErrorTip nzErrorTip="End milestone.">
                <nz-input-group [nzAddOnAfter]="(getDateBasedOnMilestone(milestoneIndexEndControl.value) | date:'short') || undefined">
                  <nz-input-number class="w-full rounded-r-none"
                    nzSize="large"
                    [nzMin]="milestoneIndexStartControl.value"
                    [formControl]="milestoneIndexEndControl"
                    i18n-nzPlaceHolder
                    nzPlaceHolder="End milestone"
                  >
                  </nz-input-number>
              </nz-input-group>
              </nz-form-control>
            </nz-form-item>
          </div>
          <nz-form-item>
            <nz-form-control i18n-nzErrorTip nzErrorTip="Proposal description is required.">
              <textarea
                nz-input
                nzSize="large"
                i18n-placeholder
                placeholder="Proposal description"
                rows="4"
                [formControl]="additionalInfoControl"
              ></textarea>
            </nz-form-control>
          </nz-form-item>
        </nz-card>
        <nz-card [nzBordered]="false">
          <nz-card-meta class="mb-4"
            i18n-nzTitle
            nzTitle="Question Info"
            i18n-nzDescription
            nzDescription="Title and description will only be displayed for this question."
          >
          </nz-card-meta>
          <ng-container
            *ngFor="let question of questions.controls; let i = index"
          >
            <nz-form-item>
              <nz-form-control i18n-nzErrorTip nzErrorTip="Question Title is required.">
                <input
                  nz-input
                  i18n-placeholder
                  placeholder="Question Title"
                  nzSize="large"
                  [formControl]="gForm(question, 'text')"
                />
              </nz-form-control>
            </nz-form-item>

            <nz-form-item>
              <nz-form-control>
                <textarea
                  nz-input
                  i18n-placeholder
                  placeholder="Question description"
                  nzSize="large"
                  rows="4"
                  [formControl]="gForm(question, 'additionalInfo')"
                ></textarea>
              </nz-form-control>
            </nz-form-item>
          </ng-container>
        </nz-card>

        <!-- <button nz-button nzType="primary" nzSize="small" type="button" (click)="addQuestion()"
      i18n>Add Question</button>
              <button nz-button nzType="primary" nzSize="small" type="button" (click)="removeQuestion(i)"
              *ngIf="questions.controls.length > 1">Remove Question</button>-->

        <ng-container *ngFor="let question of questions.controls; let i = index">
          <nz-card
            *ngFor="let answer of getAnswers(question); let ii = index"
            [nzBordered]="false"
            class="relative"
          >
            <nz-card-meta
              [nzTitle]="getAnswerTitle(ii+1)"
              i18n-nzDescription
              nzDescription="Text and description for each individual answer."
            >
            </nz-card-meta>
            <wen-icon-trash
                *ngIf="ii > 1"
                class="absolute top-6 right-8 cursor-pointer text-icons-destructive dark:text-icons-destructive-dark"
                (click)="removeAnswer(question, ii)"
            ></wen-icon-trash>
            <div class="mt-4 space-y-4">
              <nz-form-item>
                <nz-form-control i18n-nzErrorTip nzErrorTip="Answer Text is required.">
                  <input
                    nz-input
                    i18n-placeholder
                    placeholder="Answer Text"
                    nzSize="large"
                    [formControl]="gForm(answer, 'text')"
                  />
                </nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-control>
                  <textarea
                    nz-input
                    i18n-placeholder
                    placeholder="Answer description"
                    nzSize="large"
                    rows="4"
                    [formControl]="gForm(answer, 'additionalInfo')"
                  ></textarea>
                </nz-form-control>
              </nz-form-item>
            </div>
          </nz-card>
          <button
            nz-button
            type="button"
            class="wen-secondary"
            (click)="addAnswer(question)"
            *ngIf="getAnswers(question).length < 4"
          >
            <i nz-icon nzType="plus" nzTheme="outline"></i><span i18n>Add Choice</span>
          </button>
        </ng-container>
      </div>

      <div class="mt-4 space-y-4 lg:mt-0 lg:max-w-450" nz-col [nzFlex]="(deviceService.isDesktop$ | async) ? '450px' : 'auto'">
        <nz-card [nzBordered]="false">
          <nz-card-meta
            i18n-nzTitle
            nzTitle="Space Info"
            i18n-nzDescription
            nzDescription="This is the space that will list the proposal."
          >
          </nz-card-meta>
          <nz-form-item class="mt-4">
            <nz-form-control i18n-nzErrorTip nzErrorTip="Space is required.">
              <nz-select
                class="w-full"
                nzSize="large"
                nzShowSearch
                [nzCustomTemplate]="selectTpl"
                nzAllowClear
                [nzPlaceHolder]="placeholderTpl"
                [formControl]="spaceControl"
              >
                <nz-option
                  *ngFor="let s of spaces$ | async; trackBy: trackByUid"
                  nzCustomContent
                  [nzLabel]="s.name || s.uid"
                  [nzValue]="s.uid"
                >
                  <nz-avatar
                    [nzSrc]="previewImageService.getAvatarSize(s.avatarUrl)"
                    [nzSize]="32"
                    class="mr-3 border-2 border-foregrounds-tertiary dark:border-foregrounds-tertiary-dark"
                    nzShape="circle"
                  >
                  </nz-avatar>
                  {{s.name || s.uid}}
                </nz-option>
              </nz-select>
              <ng-template #placeholderTpl>
                <div class="flex items-center space-x-4">
                  <wen-icon-globe [size]="20" class="text-foregrounds-primary dark:text-foregrounds-primary-dark"></wen-icon-globe>
                  <span i18n>Select a space</span>
                </div>
              </ng-template>
              <ng-template #selectTpl let-s>
                <div class="flex items-center space-x-4">
                  <wen-icon-globe [size]="20" class="text-foregrounds-secondary dark:text-foregrounds-secondary-dark"></wen-icon-globe>
                  <span>{{ s.nzLabel }}</span>
                </div>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
        </nz-card>
        <nz-card [nzBordered]="false">
          <nz-card-meta
            i18n-nzTitle
            nzTitle="Proposal Setup"
            i18n-nzDescription
            nzDescription="Defines who has access to the proposal and what is the voting method."
          >
          </nz-card-meta>
          <nz-form-item class="mt-4">
            <nz-form-control>
              <nz-form-label class="text-sm font-medium text-foregrounds-secondary dark:text-foregrounds-secondary-dark" i18n>Target Participants</nz-form-label>
              <br/>
              <nz-radio-group
                class="wen-radio-group"
                [formControl]="selectedGroupControl"
              >
                <wen-radio [value]="targetGroups.GUARDIANS"
                  ><span class="flex items-center"><span class="text-foregrounds-primary dark:text-foregrounds-primary-dark" i18n>All Guardians</span>
                    <wen-icon-question-circle
                      class="inline-block"
                      nz-tooltip
                      nzTooltipPlacement="right"
                      i18n-nzTooltipTitle
                      nzTooltipTitle="Only guardians can vote on this proposal"
                    ></wen-icon-question-circle> </span
                ></wen-radio>
                <wen-radio [value]="targetGroups.MEMBERS"
                  ><span class="flex items-center"><span class="text-foregrounds-primary dark:text-foregrounds-primary-dark" i18n>All Members</span>
                    <wen-icon-question-circle
                      class="inline-block"
                      nz-tooltip
                      nzTooltipPlacement="right"
                      i18n-nzTooltipTitle
                      nzTooltipTitle="All members can vote on this proposal"
                    ></wen-icon-question-circle> </span
                ></wen-radio>

                <wen-radio *ngIf="!isProd" [value]="targetGroups.NATIVE"
                  ><span class="flex items-center"><span class="text-foregrounds-primary dark:text-foregrounds-primary-dark" i18n>IOTA Token Holders</span>
                    <wen-icon-question-circle
                      class="inline-block"
                      nz-tooltip
                      nzTooltipPlacement="right"
                      i18n-nzTooltipTitle
                      nzTooltipTitle="All IOTA token holders can vote."
                    ></wen-icon-question-circle> </span
                ></wen-radio>
              </nz-radio-group>
            </nz-form-control>
          </nz-form-item>
          <nz-form-item *ngIf="selectedGroupControl.value !== targetGroups.NATIVE">
            <nz-form-control>
              <nz-form-label class="text-sm font-medium text-foregrounds-secondary dark:text-foregrounds-secondary-dark" i18n>Voting Type</nz-form-label>
              <br/>
              <nz-radio-group
                class="wen-radio-group"
                [formControl]="subTypeControl"
              >
                <wen-radio [value]="subTypes.ONE_MEMBER_ONE_VOTE">
                  <span class="flex items-center"><span class="text-foregrounds-primary dark:text-foregrounds-primary-dark" i18n>Member - One Vote</span>
                    <wen-icon-question-circle
                      class="inline-block"
                      nz-tooltip
                      nzTooltipPlacement="right"
                      i18n-nzTooltipTitle
                      nzTooltipTitle="Each member of the space gets one vote"
                    ></wen-icon-question-circle> </span
                ></wen-radio>
                <wen-radio
                  class="flex"
                  [value]="subTypes.REPUTATION_BASED_ON_SPACE"
                >
                  <p class="max-w-xs pr-2 flex items-center">
                    <span class="text-foregrounds-primary dark:text-foregrounds-primary-dark" i18n>XP Reputation - Space</span>
                    <wen-icon-question-circle
                      class="inline-block"
                      nz-tooltip
                      nzTooltipPlacement="right"
                      i18n-nzTooltipTitle
                      nzTooltipTitle="Votes are weighted based on total amount of XP a member has in the space"
                    >
                    </wen-icon-question-circle>
                  </p>
                </wen-radio>
                <wen-radio
                  class="flex"
                  [value]="subTypes.REPUTATION_BASED_ON_SPACE_WITH_ALLIANCE"
                >
                  <p class="max-w-xs pr-2 flex items-center">
                    <span class="text-foregrounds-primary dark:text-foregrounds-primary-dark" i18n>XP Reputation - Space + Connection</span>
                    <wen-icon-question-circle
                      class="inline-block"
                      nz-tooltip
                      nzTooltipPlacement="right"
                      i18n-nzTooltipTitle
                      nzTooltipTitle="Votes are weighted based on total amount of XP a member has in the space & connections"
                    >
                    </wen-icon-question-circle>
                  </p>
                </wen-radio>
                <wen-radio
                  class="flex"
                  [value]="subTypes.REPUTATION_BASED_ON_AWARDS"
                >
                  <p class="max-w-xs flex items-center">
                    <span class="text-foregrounds-primary dark:text-foregrounds-primary-dark" i18n>XP Reputation - Selected Badges</span>
                    <wen-icon-question-circle
                      class="inline-block"
                      nz-tooltip
                      nzTooltipPlacement="right"
                      i18n-nzTooltipTitle
                      nzTooltipTitle="Votes are weighted based on total amount of XP a member has for selected badges"
                    >
                    </wen-icon-question-circle>
                  </p>
                </wen-radio>
              </nz-radio-group>
            </nz-form-control>
          </nz-form-item>
        </nz-card>
        <nz-card
          [nzBordered]="false"
          i18n-nzTitle
          nzTitle="Reputation Options"
          *ngIf="subTypeControl.value === subTypes.REPUTATION_BASED_ON_AWARDS || subTypeControl.value === subTypes.REPUTATION_BASED_ON_SPACE || subTypeControl.value === subTypes.REPUTATION_BASED_ON_SPACE_WITH_ALLIANCE"
        >
          <nz-form-item *ngIf="subTypeControl.value === subTypes.REPUTATION_BASED_ON_SPACE || subTypeControl.value === subTypes.REPUTATION_BASED_ON_SPACE_WITH_ALLIANCE">
            <nz-form-control>
              <nz-input-group>
                <nz-input-number class="w-full rounded-r-none"
                  nzSize="large"
                  [nzMin]="defaultMinWeight.value"
                  [formControl]="defaultMinWeight"
                  i18n-nzPlaceHolder
                  nzPlaceHolder="Set Minimum Weight">
                </nz-input-number>
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
          <nz-form-item *ngIf="subTypeControl.value === subTypes.REPUTATION_BASED_ON_AWARDS">
            <nz-form-control>
              <nz-select
                class="w-full"
                nzSize="large"
                nzShowSearch
                nzAllowClear
                [nzMaxTagCount]="9"
                nzMode="multiple"
                i18n-nzPlaceHolder
                nzPlaceHolder="Select Badge"
                [formControl]="votingAwardControl"
              >
                <nz-option
                  *ngFor="let a of awards$ | async; trackBy: trackByUid"
                  [nzLabel]="getAwardLabel(a)"
                  [nzValue]="a.uid"
                ></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </nz-card>
      </div>
    </div>
  </form>

  <nz-divider class="mb-8"></nz-divider>

  <button
    nz-button
    nzType="primary"
    nzSize="large"
    type="button"
    (click)="create()"
    class="w-full mt-8 lg:w-auto mb-18 lg:mb-6 lg:mt-0"
    i18n
  >
    Create Proposal
  </button>
</wen-content>
